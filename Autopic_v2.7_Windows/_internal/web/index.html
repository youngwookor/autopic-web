<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autopic - AI ìƒí’ˆ ì´ë¯¸ì§€ ìƒì„±ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        * { font-family: 'Inter', 'Malgun Gothic', sans-serif; box-sizing: border-box; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 3px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-pulse { animation: pulse 1.5s ease-in-out infinite; }
        .drop-zone { transition: all 0.3s ease; }
        .drop-zone.dragover { border-color: #a3e635 !important; background-color: #f7fee7 !important; }
        .tab-btn.active { background: white; color: #18181b; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .image-card { position: relative; transition: all 0.2s ease; overflow: hidden; cursor: pointer; }
        .image-card:hover { transform: scale(1.02); box-shadow: 0 10px 30px rgba(0,0,0,0.12); }
        .progress-bar { transition: width 0.3s ease; }
        .biz-type-btn.active { border-color: #a3e635 !important; background-color: #f7fee7 !important; }
        .model-btn.active { border-color: #a3e635 !important; background-color: #f7fee7 !important; }
    </style>
</head>
<body class="bg-zinc-100 h-screen flex flex-col overflow-hidden">
    <header class="bg-white border-b border-zinc-200 px-6 py-3 flex items-center justify-between shrink-0 shadow-sm">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="w-9 h-9 bg-zinc-900 rounded-xl flex items-center justify-center">
                    <svg viewBox="0 0 24 24" class="w-5 h-5 text-lime-400" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                </div>
                <span class="text-xl font-black tracking-tight">Autopic</span>
            </div>
            <span class="text-[10px] font-bold bg-lime-400 text-zinc-900 px-2.5 py-1 rounded-full">v2.7</span>
            <span id="businessTypeDisplay" class="text-xs font-bold bg-zinc-100 text-zinc-600 px-3 py-1.5 rounded-full">ğŸ‘œ ëª…í’ˆ íŒ¨ì…˜</span>
        </div>
        <div class="flex items-center gap-3">
            <div id="keyNameDisplay" class="hidden flex items-center gap-2 px-3 py-1.5 bg-blue-50 rounded-full">
                <span class="text-blue-500">ğŸ‘¤</span>
                <span id="keyNameText" class="text-xs font-bold text-blue-700"></span>
            </div>
            <div id="apiStatus" class="flex items-center gap-2 px-3 py-1.5 bg-zinc-50 rounded-full">
                <span class="w-2 h-2 rounded-full bg-red-500"></span>
                <span class="text-xs font-medium text-zinc-500">API ë¯¸ì—°ê²°</span>
            </div>
        </div>
    </header>

    <div class="bg-white border-b border-zinc-200 px-6 shrink-0">
        <div class="flex gap-1 py-2">
            <button onclick="switchTab('studio')" class="tab-btn active px-5 py-2.5 text-sm font-bold rounded-xl" data-tab="studio">ğŸ¨ AI ìŠ¤íŠœë””ì˜¤</button>
            <button onclick="switchTab('batch')" class="tab-btn px-5 py-2.5 text-sm font-bold rounded-xl text-zinc-400" data-tab="batch">ğŸ“¦ ì¼ê´„ ì²˜ë¦¬</button>
            <button onclick="switchTab('settings')" class="tab-btn px-5 py-2.5 text-sm font-bold rounded-xl text-zinc-400" data-tab="settings">âš™ï¸ ì„¤ì •</button>
            <button onclick="switchTab('logs')" class="tab-btn px-5 py-2.5 text-sm font-bold rounded-xl text-zinc-400" data-tab="logs">ğŸ“ ë¡œê·¸</button>
        </div>
    </div>

    <main class="flex-1 overflow-hidden">
        <!-- Studio Tab -->
        <div id="tab-studio" class="tab-content h-full flex">
            <aside class="w-[420px] bg-white border-r border-zinc-200 flex flex-col shrink-0">
                <div class="p-5 border-b border-zinc-100 flex items-center justify-between">
                    <h2 class="text-lg font-bold">AI Studio</h2>
                </div>
                <div class="flex-1 overflow-y-auto p-5 space-y-5">
                    <section>
                        <label class="text-xs font-black text-zinc-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                            <span class="w-5 h-5 bg-zinc-900 rounded-md flex items-center justify-center text-white text-[10px]">1</span>ì‚¬ì§„ ì—…ë¡œë“œ
                        </label>
                        <div id="dropZone" class="drop-zone border-2 border-dashed border-zinc-300 rounded-2xl p-8 text-center cursor-pointer hover:border-lime-400 bg-zinc-50/50">
                            <input type="file" id="fileInput" accept="image/*" class="hidden">
                            <div id="uploadPlaceholder">
                                <div class="w-14 h-14 bg-zinc-100 rounded-2xl flex items-center justify-center mx-auto mb-3">
                                    <svg class="w-7 h-7 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                                </div>
                                <p class="text-sm font-bold text-zinc-700">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</p>
                                <p class="text-xs text-zinc-400 mt-1">JPG, PNG, WebP ì§€ì›</p>
                            </div>
                            <div id="previewContainer" class="hidden">
                                <img id="previewImage" class="max-h-44 mx-auto rounded-xl shadow-lg">
                                <p id="fileName" class="text-xs text-zinc-500 mt-3 truncate font-medium"></p>
                            </div>
                        </div>
                        <button id="clearImageBtn" onclick="clearImage()" class="hidden w-full mt-2 py-2 text-sm font-medium text-zinc-400 hover:text-red-500 rounded-lg">ğŸ—‘ï¸ ì´ë¯¸ì§€ ì‚­ì œ</button>
                    </section>
                    <section>
                        <label class="text-xs font-black text-zinc-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                            <span class="w-5 h-5 bg-zinc-900 rounded-md flex items-center justify-center text-white text-[10px]">2</span>ì œì‘ ì˜µì…˜
                        </label>
                        <div class="space-y-4 bg-zinc-50/50 rounded-2xl p-4">
                            <div>
                                <label class="text-[10px] font-bold text-zinc-500 mb-1.5 block uppercase">ì´ë¯¸ì§€ íƒ€ì…</label>
                                <div class="grid grid-cols-2 gap-1.5 p-1.5 bg-zinc-100 rounded-xl">
                                    <button onclick="setMode('product')" id="modeProduct" class="py-2.5 text-xs font-bold rounded-lg bg-white shadow-sm">ğŸ›ï¸ ì •ë¬¼</button>
                                    <button onclick="setMode('model')" id="modeModel" class="py-2.5 text-xs font-bold rounded-lg text-zinc-400">ğŸ‘¤ ëª¨ë¸</button>
                                </div>
                            </div>
                            <div id="genderSection" class="hidden">
                                <label class="text-[10px] font-bold text-zinc-500 mb-1.5 block uppercase">ëª¨ë¸ ì„±ë³„</label>
                                <div class="grid grid-cols-2 gap-1.5 p-1.5 bg-zinc-100 rounded-xl">
                                    <button onclick="setGender('ì—¬ì„±')" id="genderFemale" class="py-2.5 text-xs font-bold rounded-lg bg-zinc-900 text-white">ğŸ‘© ì—¬ì„±</button>
                                    <button onclick="setGender('ë‚¨ì„±')" id="genderMale" class="py-2.5 text-xs font-bold rounded-lg text-zinc-400">ğŸ‘¨ ë‚¨ì„±</button>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
                <div class="p-5 border-t border-zinc-100 bg-zinc-50/30">
                    <button id="generateBtn" onclick="generateImage()" disabled class="w-full py-4 bg-zinc-900 text-white rounded-2xl font-black text-sm flex items-center justify-center gap-2 disabled:opacity-40 hover:bg-lime-400 hover:text-zinc-900 transition-all">
                        <span id="generateBtnIcon">âœ¨</span><span id="generateBtnText">ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°</span>
                        <span id="generateBtnLoading" class="hidden"><svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg></span>
                    </button>
                </div>
            </aside>
            <section class="flex-1 bg-zinc-50 flex flex-col">
                <div class="h-12 border-b border-zinc-200 flex items-center justify-between px-5 bg-white/80">
                    <span class="text-xs font-black text-zinc-400 uppercase tracking-widest">Canvas View</span>
                    <span id="canvasInfo" class="text-xs font-medium text-zinc-400"></span>
                </div>
                <div id="canvasArea" class="flex-1 flex items-center justify-center p-8 overflow-auto" style="background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 24px 24px;">
                    <div id="emptyState" class="text-center animate-fade-in">
                        <div class="w-24 h-24 bg-zinc-100 rounded-3xl flex items-center justify-center mx-auto mb-6">
                            <svg viewBox="0 0 24 24" class="w-12 h-12 text-zinc-300" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                        </div>
                        <p class="text-xl font-black text-zinc-300">ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì—¬</p>
                        <p class="text-xl font-black text-zinc-300">ìŠ¤íŠœë””ì˜¤ ì´¬ì˜ì„ ì‹œì‘í•˜ì„¸ìš”</p>
                    </div>
                    <div id="loadingState" class="hidden text-center animate-fade-in">
                        <div class="bg-white p-12 rounded-[32px] shadow-2xl border border-zinc-100">
                            <div class="w-16 h-16 border-4 border-lime-400 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
                            <p class="text-xl font-black text-zinc-900 mb-2">ì´ë¯¸ì§€ ìƒì„± ì¤‘</p>
                            <p class="text-sm text-zinc-400">AIê°€ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                        </div>
                    </div>
                    <div id="resultGrid" class="hidden w-full max-w-4xl grid grid-cols-2 gap-5 animate-fade-in"></div>
                </div>
            </section>
            <aside class="w-[280px] bg-white border-l border-zinc-200 flex flex-col shrink-0">
                <div class="p-4 border-b border-zinc-100"><h3 class="font-bold text-sm">ğŸ“œ íˆìŠ¤í† ë¦¬</h3></div>
                <div id="historyList" class="flex-1 overflow-y-auto p-3"><p class="text-sm text-zinc-400 text-center py-8">ìƒì„±ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>
                <div class="p-4 border-t border-zinc-100">
                    <button id="downloadAllBtn" onclick="downloadAll()" disabled class="w-full py-3 bg-zinc-900 text-white rounded-xl text-sm font-bold hover:bg-lime-400 hover:text-zinc-900 disabled:opacity-40">ğŸ“¥ ì „ì²´ ë‹¤ìš´ë¡œë“œ</button>
                </div>
            </aside>
        </div>

        <!-- Batch Tab -->
        <div id="tab-batch" class="tab-content hidden h-full p-6 overflow-auto">
            <div class="max-w-5xl mx-auto space-y-5">
                <!-- ì‚¬ìš© ê°€ì´ë“œ -->
                <details class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border border-blue-100 overflow-hidden">
                    <summary class="p-4 cursor-pointer flex items-center gap-3 font-bold text-blue-800 hover:bg-blue-100/50">
                        <span class="text-xl">ğŸ“–</span>
                        <span>ì‚¬ìš© ê°€ì´ë“œ (í´ë¦­í•˜ì—¬ í¼ì¹˜ê¸°)</span>
                        <svg class="w-5 h-5 ml-auto transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </summary>
                    <div class="p-5 pt-2 space-y-4 text-sm">
                        <div class="bg-white rounded-xl p-4 border border-blue-100">
                            <h4 class="font-bold text-blue-900 mb-2 flex items-center gap-2">ğŸ“ í´ë” êµ¬ì¡°</h4>
                            <pre class="bg-zinc-900 text-zinc-300 p-3 rounded-lg text-xs overflow-x-auto">ì‘ì—…í´ë”/
â”œâ”€â”€ ìƒí’ˆ1/
â”‚   â”œâ”€â”€ 5.jpg (ë˜ëŠ” ì•„ë¬´ì´ë¦„.jpg) â† ì›ë³¸ ì´ë¯¸ì§€
â”‚   â””â”€â”€ ì„¤ëª….txt (ì„ íƒ) â† ìƒí’ˆ ì„¤ëª…
â”œâ”€â”€ ìƒí’ˆ2/
â”‚   â”œâ”€â”€ image.png
â”‚   â””â”€â”€ info.txt
â””â”€â”€ ...</pre>
                        </div>
                        <div class="bg-white rounded-xl p-4 border border-blue-100">
                            <h4 class="font-bold text-blue-900 mb-2 flex items-center gap-2">ğŸ“¦ ê²°ê³¼ë¬¼</h4>
                            <div class="grid grid-cols-2 gap-3 text-xs">
                                <div class="bg-zinc-50 p-3 rounded-lg">
                                    <p class="font-bold text-zinc-700 mb-1">ğŸ–¼ï¸ ì´ë¯¸ì§€</p>
                                    <p class="text-zinc-500">ê° í´ë” ë‚´ <code class="bg-zinc-200 px-1 rounded">output/</code> í´ë”ì— ì €ì¥</p>
                                </div>
                                <div class="bg-zinc-50 p-3 rounded-lg">
                                    <p class="font-bold text-zinc-700 mb-1">ğŸ“Š ì—‘ì…€</p>
                                    <p class="text-zinc-500">ì‘ì—…í´ë”ì— <code class="bg-zinc-200 px-1 rounded">í´ë”ëª…_result.xlsx</code> ìƒì„±</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-amber-50 rounded-xl p-4 border border-amber-200">
                            <h4 class="font-bold text-amber-800 mb-2 flex items-center gap-2">ğŸ’¡ ì—‘ì…€ ì¶œë ¥ í˜•ì‹</h4>
                            <ul class="text-amber-700 space-y-1 ml-4 list-disc text-xs">
                                <li><strong>ëª…í’ˆ íŒ¨ì…˜:</strong> ì—…ì¢… | ìƒí’ˆì½”ë“œ | ë¸Œëœë“œ | ìƒí’ˆëª… | SEOì œëª© | SEOì„¤ëª… | SEOí‚¤ì›Œë“œ</li>
                                <li><strong>ì¼ë°˜/í«/í‚¤ì¦ˆ:</strong> ì—…ì¢… | ìƒí’ˆì½”ë“œ | ìƒí’ˆëª… | SEOì œëª© | SEOì„¤ëª… | SEOí‚¤ì›Œë“œ</li>
                            </ul>
                        </div>
                    </div>
                </details>
                
                <!-- ì‘ì—… í´ë” -->
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-zinc-100">
                    <h3 class="font-bold mb-4 flex items-center gap-2">ğŸ“ ì‘ì—… í´ë”</h3>
                    <div class="flex gap-2">
                        <input type="text" id="batchFolderInput" class="flex-1 bg-zinc-50 border border-zinc-200 rounded-xl px-4 py-2.5 text-sm" placeholder="í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”" readonly>
                        <button onclick="selectBatchFolder()" class="px-5 py-2.5 bg-zinc-900 text-white rounded-xl text-sm font-bold hover:bg-zinc-800">ğŸ“‚ ì„ íƒ</button>
                        <button onclick="openBatchFolder()" class="px-4 py-2.5 bg-zinc-100 rounded-xl text-sm hover:bg-zinc-200">ì—´ê¸°</button>
                    </div>
                </div>

                <!-- í´ë” êµ¬ì¡° ë¯¸ë¦¬ë³´ê¸° -->
                <div id="folderPreview" class="hidden bg-white rounded-2xl p-5 shadow-sm border border-zinc-100">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold flex items-center gap-2">ğŸ” í´ë” ì¸ì‹ ê²°ê³¼</h3>
                        <div id="folderSummary" class="flex gap-2">
                            <span class="px-2.5 py-1 text-xs font-bold bg-lime-100 text-lime-700 rounded-lg">âœ… ìƒí’ˆ <span id="validCount">0</span>ê°œ</span>
                            <span class="px-2.5 py-1 text-xs font-bold bg-amber-100 text-amber-700 rounded-lg hidden" id="warningBadge">âš ï¸ ë¬¸ì œ <span id="warningCount">0</span>ê°œ</span>
                            <span class="px-2.5 py-1 text-xs font-bold bg-zinc-100 text-zinc-500 rounded-lg">ğŸ“„ ë¬´ì‹œ <span id="ignoredCount">0</span>ê°œ</span>
                        </div>
                    </div>
                    <div class="bg-zinc-900 rounded-xl p-4 font-mono text-xs max-h-[200px] overflow-y-auto">
                        <div id="folderTree" class="text-zinc-300 space-y-0.5"></div>
                    </div>
                    <div id="folderTips" class="mt-3 p-3 bg-blue-50 rounded-xl text-xs text-blue-700 hidden">
                        <span class="font-bold">ğŸ’¡ íŒ:</span> <span id="folderTipText"></span>
                    </div>
                </div>

                <!-- ì¤‘ë‹¨ëœ ì‘ì—… ì•Œë¦¼ -->
                <div id="resumeAlert" class="hidden bg-amber-50 border border-amber-200 rounded-2xl p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">âš ï¸</span>
                            <div>
                                <p class="font-bold text-amber-800">ì¤‘ë‹¨ëœ ì‘ì—…ì´ ìˆìŠµë‹ˆë‹¤</p>
                                <p id="resumeInfo" class="text-sm text-amber-600"></p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="resumeBatch()" class="px-4 py-2 bg-amber-500 text-white rounded-xl text-sm font-bold hover:bg-amber-600">â–¶ï¸ ì´ì–´í•˜ê¸°</button>
                            <button onclick="clearBatchState()" class="px-3 py-2 bg-zinc-200 rounded-xl text-sm hover:bg-zinc-300">âœ•</button>
                        </div>
                    </div>
                </div>

                <!-- ìƒí’ˆ ëª©ë¡ -->
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-zinc-100">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold flex items-center gap-2">ğŸ“‹ ìƒí’ˆ ëª©ë¡</h3>
                        <div class="flex gap-2">
                            <button onclick="refreshProductList()" class="px-3 py-1.5 text-xs font-bold bg-zinc-100 rounded-lg hover:bg-zinc-200">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                            <button onclick="toggleSelectAll()" class="px-3 py-1.5 text-xs font-bold bg-zinc-100 rounded-lg hover:bg-zinc-200">âœ… ì „ì²´ì„ íƒ</button>
                            <span id="productCount" class="px-3 py-1.5 text-xs font-bold bg-lime-100 text-lime-700 rounded-lg">0ê°œ</span>
                        </div>
                    </div>
                    <div class="border border-zinc-200 rounded-xl overflow-hidden max-h-[350px] overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-zinc-50 sticky top-0">
                                <tr class="text-zinc-500">
                                    <th class="w-12 p-3"><input type="checkbox" id="selectAllCheck" onchange="toggleSelectAll()" class="w-4 h-4 accent-lime-500"></th>
                                    <th class="text-left p-3 font-bold">í´ë”ëª…</th>
                                    <th class="w-20 p-3 font-bold">ì´ë¯¸ì§€</th>
                                    <th class="w-20 p-3 font-bold">í…ìŠ¤íŠ¸</th>
                                    <th class="w-28 p-3 font-bold">ìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody id="productTableBody">
                                <tr><td colspan="5" class="p-8 text-center text-zinc-400">í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ìƒì„± ì˜µì…˜ -->
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-zinc-100">
                    <h3 class="font-bold mb-4 flex items-center gap-2">ğŸ¨ ìƒì„± ì˜µì…˜</h3>
                    <div class="flex flex-wrap items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer bg-zinc-50 px-4 py-2.5 rounded-xl hover:bg-zinc-100">
                            <input type="checkbox" id="optBasicProduct" checked class="w-4 h-4 accent-lime-500">
                            <span class="text-sm font-medium">ğŸ›ï¸ ê¸°ë³¸ ì •ë¬¼ (4ì¥)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer bg-zinc-50 px-4 py-2.5 rounded-xl hover:bg-zinc-100">
                            <input type="checkbox" id="optBasicModel" checked class="w-4 h-4 accent-lime-500">
                            <span class="text-sm font-medium">ğŸ‘¤ ê¸°ë³¸ ëª¨ë¸ (4ì¥)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer bg-zinc-50 px-4 py-2.5 rounded-xl hover:bg-zinc-100">
                            <input type="checkbox" id="optEditorialProduct" class="w-4 h-4 accent-lime-500">
                            <span class="text-sm font-medium">ğŸ“¸ í™”ë³´ ì •ë¬¼ (4ì¥)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer bg-zinc-50 px-4 py-2.5 rounded-xl hover:bg-zinc-100">
                            <input type="checkbox" id="optEditorialModel" class="w-4 h-4 accent-lime-500">
                            <span class="text-sm font-medium">ğŸ­ í™”ë³´ ëª¨ë¸ (4ì¥)</span>
                        </label>
                        <div class="flex items-center gap-2 ml-auto pl-4 border-l border-zinc-200">
                            <span class="text-sm font-bold text-zinc-600">ì„±ë³„:</span>
                            <button id="batchGenderAuto" onclick="setBatchGender('auto')" class="batch-gender-btn px-3 py-1.5 text-xs font-bold rounded-lg bg-lime-400 text-zinc-900">ğŸ¤– ìë™</button>
                            <button id="batchGenderì—¬ì„±" onclick="setBatchGender('ì—¬ì„±')" class="batch-gender-btn px-3 py-1.5 text-xs font-bold rounded-lg bg-zinc-100 text-zinc-600">ğŸ‘© ì—¬ì„±</button>
                            <button id="batchGenderë‚¨ì„±" onclick="setBatchGender('ë‚¨ì„±')" class="batch-gender-btn px-3 py-1.5 text-xs font-bold rounded-lg bg-zinc-100 text-zinc-600">ğŸ‘¨ ë‚¨ì„±</button>
                        </div>
                    </div>
                </div>

                <!-- ì²˜ë¦¬ ë²„íŠ¼ & ì§„í–‰ë¥  -->
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-zinc-100">
                    <div class="flex items-center gap-4">
                        <button id="batchStartBtn" onclick="startBatchProcess()" class="px-8 py-3.5 bg-zinc-900 text-white rounded-xl font-bold text-sm hover:bg-lime-400 hover:text-zinc-900 flex items-center gap-2 min-w-[180px] justify-center">
                            <span id="batchBtnIcon">ğŸš€</span>
                            <span id="batchBtnText">ì²˜ë¦¬ ì‹œì‘</span>
                        </button>
                        <button id="batchStopBtn" onclick="stopBatchProcess()" disabled class="px-6 py-3.5 bg-red-500 text-white rounded-xl font-bold text-sm disabled:opacity-40 hover:bg-red-600">â¹ï¸ ì¤‘ì§€</button>
                        <div class="flex-1">
                            <div class="h-4 bg-zinc-100 rounded-full overflow-hidden">
                                <div id="batchProgress" class="progress-bar h-full bg-lime-400" style="width:0%"></div>
                            </div>
                            <p id="batchProgressText" class="text-xs text-zinc-500 mt-2 font-medium">ëŒ€ê¸° ì¤‘</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="tab-settings" class="tab-content hidden h-full p-6 overflow-auto">
            <div class="max-w-4xl mx-auto space-y-5">
                <!-- ì—°ê²° ì •ë³´ & í¬ë ˆë”§ -->
                <div class="bg-gradient-to-r from-zinc-800 to-zinc-900 rounded-2xl p-6 shadow-lg text-white">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-lg flex items-center gap-2">ğŸ”— ì—°ê²° ì •ë³´</h3>
                        <div class="flex items-center gap-2 px-3 py-1.5 bg-lime-400/20 rounded-full">
                            <span class="w-2 h-2 rounded-full bg-lime-400"></span>
                            <span class="text-xs font-medium text-lime-400">ì—°ê²°ë¨</span>
                        </div>
                    </div>
                    
                    <div class="bg-white/5 rounded-xl p-5 mb-4">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="text-zinc-400 text-sm">ë³´ìœ  í¬ë ˆë”§</p>
                                <p id="settingsCreditsValue" class="text-4xl font-black text-white">0</p>
                            </div>
                            <button onclick="refreshCredits()" class="px-4 py-2 bg-white/10 text-white rounded-xl text-sm font-medium hover:bg-white/20">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-xs">
                            <div class="bg-white/5 rounded-lg p-3 text-center">
                                <p class="text-zinc-400">Standard ëª¨ë¸</p>
                                <p class="font-bold text-white">1í¬ë ˆë”§ = 4ì¥</p>
                            </div>
                            <div class="bg-white/5 rounded-lg p-3 text-center">
                                <p class="text-zinc-400">Premium ëª¨ë¸</p>
                                <p class="font-bold text-white">3í¬ë ˆë”§ = 4ì¥</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <a href="https://autopic-web.vercel.app" target="_blank" class="px-5 py-2.5 bg-lime-400 text-zinc-900 rounded-xl font-bold text-sm hover:bg-lime-300">ğŸ’³ í¬ë ˆë”§ ì¶©ì „í•˜ê¸°</a>
                        <button onclick="logout()" class="ml-auto px-5 py-2.5 bg-red-500/20 text-red-400 rounded-xl font-bold text-sm hover:bg-red-500/30 border border-red-500/30">ğŸ”“ ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>

                <!-- ì—…ì¢… ì„¤ì • (4ê°€ì§€) -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-zinc-100">
                    <h3 class="font-bold mb-5">ğŸª ì—…ì¢… ì„¤ì •</h3>
                    <p class="text-sm text-zinc-500 mb-4">ì—…ì¢…ì— ë”°ë¼ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ê³¼ ì—‘ì…€ ì¶œë ¥ í˜•ì‹ì´ ë‹¬ë¼ì§‘ë‹ˆë‹¤.</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="setBusinessType('luxury')" id="bizTypeLuxury" class="biz-type-btn active p-4 border-2 rounded-xl text-left transition-all">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">ğŸ‘œ</span>
                                <div>
                                    <p class="font-bold text-zinc-900">ëª…í’ˆ íŒ¨ì…˜</p>
                                    <p class="text-xs text-zinc-500">ëŸ­ì…”ë¦¬ ìŠ¤íƒ€ì¼ Â· ë¸Œëœë“œ í¬í•¨</p>
                                </div>
                            </div>
                        </button>
                        <button onclick="setBusinessType('general')" id="bizTypeGeneral" class="biz-type-btn p-4 border-2 border-zinc-200 rounded-xl text-left hover:border-zinc-300 transition-all">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">ğŸ‘•</span>
                                <div>
                                    <p class="font-bold text-zinc-900">ì¼ë°˜ íŒ¨ì…˜</p>
                                    <p class="text-xs text-zinc-500">ìºì£¼ì–¼ ìŠ¤íƒ€ì¼ Â· ë¸Œëœë“œ ì—†ìŒ</p>
                                </div>
                            </div>
                        </button>
                        <button onclick="setBusinessType('pet')" id="bizTypePet" class="biz-type-btn p-4 border-2 border-zinc-200 rounded-xl text-left hover:border-zinc-300 transition-all">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">ğŸ•</span>
                                <div>
                                    <p class="font-bold text-zinc-900">í« ìš©í’ˆ</p>
                                    <p class="text-xs text-zinc-500">ë°˜ë ¤ë™ë¬¼ ì°©ìƒ· Â· ë¸Œëœë“œ ì—†ìŒ</p>
                                </div>
                            </div>
                        </button>
                        <button onclick="setBusinessType('kids')" id="bizTypeKids" class="biz-type-btn p-4 border-2 border-zinc-200 rounded-xl text-left hover:border-zinc-300 transition-all">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">ğŸ§’</span>
                                <div>
                                    <p class="font-bold text-zinc-900">í‚¤ì¦ˆ ìš©í’ˆ</p>
                                    <p class="text-xs text-zinc-500">ì•„ì´ ëª¨ë¸ ì°©ìƒ· Â· ë¸Œëœë“œ ì—†ìŒ</p>
                                </div>
                            </div>
                        </button>
                    </div>
                    <div id="businessTypeNote" class="flex items-center gap-2 p-3 bg-lime-50 rounded-xl mt-4">
                        <span>ğŸ‘œ</span>
                        <span class="text-sm text-lime-700 font-medium">ëª…í’ˆ íŒ¨ì…˜ ëª¨ë“œ: ëŸ­ì…”ë¦¬ ìŠ¤íƒ€ì¼ + ë¸Œëœë“œ ì»¬ëŸ¼ í¬í•¨</span>
                    </div>
                </div>

                <!-- ì´ë¯¸ì§€ ìƒì„± ëª¨ë¸ ì„¤ì • -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-zinc-100">
                    <h3 class="font-bold mb-5">ğŸ¤– ì´ë¯¸ì§€ ìƒì„± ëª¨ë¸</h3>
                    <p class="text-sm text-zinc-500 mb-4">ëª¨ë¸ì— ë”°ë¼ í’ˆì§ˆê³¼ ë¹„ìš©ì´ ë‹¬ë¼ì§‘ë‹ˆë‹¤.</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="setImageModel('gemini-2.5-flash')" id="modelFlash" class="model-btn p-4 border-2 border-zinc-200 rounded-xl text-left hover:border-zinc-300 transition-all">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">âš¡</span>
                                <div>
                                    <p class="font-bold text-zinc-900">Standard</p>
                                    <p class="text-xs text-zinc-500">1í¬ë ˆë”§ / ê³ ì†</p>
                                </div>
                            </div>
                        </button>
                        <button onclick="setImageModel('gemini-3-pro')" id="modelPro" class="model-btn active p-4 border-2 rounded-xl text-left transition-all">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">âœ¨</span>
                                <div>
                                    <p class="font-bold text-zinc-900">Premium</p>
                                    <p class="text-xs text-zinc-500">3í¬ë ˆë”§ / ê³ í™”ì§ˆ</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- ë¸Œëœë“œ ê´€ë¦¬ (ëª…í’ˆì¼ ë•Œë§Œ í‘œì‹œ) -->
                <div id="brandSection" class="bg-white rounded-2xl p-6 shadow-sm border border-zinc-100">
                    <h3 class="font-bold mb-5">ğŸ·ï¸ ë¸Œëœë“œ ê´€ë¦¬</h3>
                    <p class="text-sm text-zinc-500 mb-4">ëª…í’ˆ íŒ¨ì…˜ ëª¨ë“œì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤. AIê°€ ì´ ëª©ë¡ì—ì„œ ë¸Œëœë“œë¥¼ ë§¤ì¹­í•©ë‹ˆë‹¤.</p>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="newBrandInput" class="flex-1 bg-zinc-50 border border-zinc-200 rounded-xl px-4 py-2.5 text-sm" placeholder="ìƒˆ ë¸Œëœë“œ ì…ë ¥...">
                        <button onclick="addBrand()" class="px-5 py-2.5 bg-lime-400 text-zinc-900 rounded-xl text-sm font-bold">â• ì¶”ê°€</button>
                    </div>
                    <div id="brandList" class="flex flex-wrap gap-2 min-h-[50px]"><p class="text-sm text-zinc-400">ë“±ë¡ëœ ë¸Œëœë“œê°€ ì—†ìŠµë‹ˆë‹¤</p></div>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="tab-logs" class="tab-content hidden h-full p-6">
            <div class="max-w-4xl mx-auto h-full flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">ğŸ“ ì²˜ë¦¬ ë¡œê·¸</h3>
                    <button onclick="clearLogs()" class="px-4 py-2 bg-zinc-100 rounded-xl text-sm font-bold hover:bg-zinc-200">ğŸ—‘ï¸ ë¡œê·¸ ì‚­ì œ</button>
                </div>
                <div id="logContainer" class="flex-1 bg-zinc-900 rounded-2xl p-4 font-mono text-xs text-zinc-300 overflow-y-auto">
                    <p class="text-zinc-500">ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
    <div id="previewModal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-8">
        <div class="bg-white rounded-3xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-zinc-200 flex items-center justify-between">
                <h3 id="modalTitle" class="font-bold text-lg">ë¯¸ë¦¬ë³´ê¸°</h3>
                <button onclick="closePreviewModal()" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-zinc-100">âœ•</button>
            </div>
            <div id="modalContent" class="flex-1 overflow-y-auto p-5"></div>
        </div>
    </div>

    <!-- ì™„ë£Œ ëª¨ë‹¬ -->
    <div id="completeModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-8">
        <div class="bg-white rounded-3xl max-w-md w-full p-8 text-center animate-fade-in">
            <div class="w-20 h-20 bg-lime-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <span class="text-4xl">ğŸ‰</span>
            </div>
            <h3 class="text-2xl font-black text-zinc-900 mb-2">ì²˜ë¦¬ ì™„ë£Œ!</h3>
            <p id="completeMessage" class="text-zinc-500 mb-6"></p>
            <div class="flex gap-3 justify-center">
                <button onclick="openBatchFolder()" class="px-6 py-3 bg-zinc-100 text-zinc-700 rounded-xl font-bold hover:bg-zinc-200">ğŸ“‚ í´ë” ì—´ê¸°</button>
                <button onclick="closeCompleteModal()" class="px-6 py-3 bg-lime-400 text-zinc-900 rounded-xl font-bold hover:bg-lime-500">í™•ì¸</button>
            </div>
        </div>
    </div>

<script>
// ===== ìƒíƒœ =====
let state = {
    currentTab: 'studio',
    uploadedImage: null,
    mode: 'product',
    gender: 'ì—¬ì„±',
    generatedImages: [],
    batchFolder: '',
    batchProducts: [],
    batchGender: 'auto',
    isProcessing: false,
    businessType: 'luxury',
    imageModel: 'gemini-3-pro',
    brands: [],
    webApiConnected: false,
    batchTotal: 0,
    batchCurrent: 0,
};

// ===== ì´ˆê¸°í™” =====
document.addEventListener('DOMContentLoaded', () => {
    setupDropZone();
    startLogPolling();
});

// pywebviewê°€ ì¤€ë¹„ë˜ë©´ ì„¤ì • ë¡œë“œ
window.addEventListener('pywebviewready', async () => {
    await loadSettings();
});

async function loadSettings() {
    try {
        const settings = await pywebview.api.get_settings();
        
        state.businessType = settings.business_type || 'luxury';
        updateBusinessTypeUI();
        
        state.imageModel = settings.image_model || 'gemini-3-pro';
        updateImageModelUI();
        
        state.brands = settings.brands || [];
        renderBrands();
        
        // API ì—°ê²° ìƒíƒœ - í•­ìƒ ì—°ê²°ë¨ (ë¡œê·¸ì¸ í™”ë©´ ê±°ì³ì˜´)
        state.webApiConnected = true;
        updateApiStatus(true);
        
        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ë¡œê·¸ì¸ ì •ë³´ í™•ì¸ (ë¡œê·¸ì¸ ì§í›„)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('loggedIn') === 'true') {
            // ë¡œê·¸ì¸ ì§í›„ - URLì—ì„œ ì •ë³´ ë°”ë¡œ í‘œì‹œ
            const credits = urlParams.get('credits') || '0';
            const keyName = urlParams.get('keyName') || '';
            
            // í¬ë ˆë”§ í‘œì‹œ
            document.getElementById('settingsCreditsValue').textContent = credits;
            
            // ìƒë‹¨ API ìƒíƒœ ì—°ê²°ë¨ìœ¼ë¡œ í‘œì‹œ
            updateApiStatus(true);
            
            // í‚¤ ì´ë¦„ í‘œì‹œ
            if (keyName) {
                document.getElementById('keyNameDisplay').classList.remove('hidden');
                document.getElementById('keyNameDisplay').classList.add('flex');
                document.getElementById('keyNameText').textContent = keyName;
            }
            
            // URL íŒŒë¼ë¯¸í„° ì œê±° (ì£¼ì†Œì°½ ê¹”ë”í•˜ê²Œ)
            window.history.replaceState({}, document.title, window.location.pathname);
        } else {
            // ì¼ë°˜ ì‹¤í–‰ (ì €ì¥ëœ í‚¤ë¡œ ìë™ ë¡œê·¸ì¸) - í¬ë ˆë”§ ì¡°íšŒ
            await refreshCredits();
        }
        
        if (settings.last_folder) {
            document.getElementById('batchFolderInput').value = settings.last_folder;
            state.batchFolder = settings.last_folder;
            loadProductList(settings.last_folder);
        }
    } catch (e) {
        console.error('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e);
    }
}

// ===== ì—…ì¢… ì„¤ì • =====
async function setBusinessType(type) {
    state.businessType = type;
    
    try {
        const result = await pywebview.api.save_business_type(type);
        if (result.success) {
            updateBusinessTypeUI();
        }
    } catch (e) {
        console.error('ì—…ì¢… ì €ì¥ ì‹¤íŒ¨:', e);
    }
}

function updateBusinessTypeUI() {
    const types = {
        luxury: { icon: 'ğŸ‘œ', name: 'ëª…í’ˆ íŒ¨ì…˜', note: 'ëª…í’ˆ íŒ¨ì…˜ ëª¨ë“œ: ëŸ­ì…”ë¦¬ ìŠ¤íƒ€ì¼ + ë¸Œëœë“œ ì»¬ëŸ¼ í¬í•¨', useBrand: true },
        general: { icon: 'ğŸ‘•', name: 'ì¼ë°˜ íŒ¨ì…˜', note: 'ì¼ë°˜ íŒ¨ì…˜ ëª¨ë“œ: ìºì£¼ì–¼ ìŠ¤íƒ€ì¼ Â· ë¸Œëœë“œ ì—†ìŒ', useBrand: false },
        pet: { icon: 'ğŸ•', name: 'í« ìš©í’ˆ', note: 'í« ìš©í’ˆ ëª¨ë“œ: ë°˜ë ¤ë™ë¬¼ ì°©ìƒ· Â· ë¸Œëœë“œ ì—†ìŒ', useBrand: false },
        kids: { icon: 'ğŸ§’', name: 'í‚¤ì¦ˆ ìš©í’ˆ', note: 'í‚¤ì¦ˆ ìš©í’ˆ ëª¨ë“œ: ì•„ì´ ëª¨ë¸ ì°©ìƒ· Â· ë¸Œëœë“œ ì—†ìŒ', useBrand: false },
    };
    
    const current = types[state.businessType] || types.luxury;
    
    document.querySelectorAll('.biz-type-btn').forEach(btn => {
        btn.classList.remove('active', 'border-lime-400', 'bg-lime-50');
        btn.classList.add('border-zinc-200');
    });
    
    const btnIds = { luxury: 'bizTypeLuxury', general: 'bizTypeGeneral', pet: 'bizTypePet', kids: 'bizTypeKids' };
    const activeBtn = document.getElementById(btnIds[state.businessType]);
    if (activeBtn) {
        activeBtn.classList.add('active', 'border-lime-400', 'bg-lime-50');
        activeBtn.classList.remove('border-zinc-200');
    }
    
    document.getElementById('businessTypeDisplay').innerHTML = `${current.icon} ${current.name}`;
    document.getElementById('businessTypeNote').innerHTML = `<span>${current.icon}</span><span class="text-sm text-lime-700 font-medium">${current.note}</span>`;
    
    const brandSection = document.getElementById('brandSection');
    brandSection.classList.toggle('hidden', !current.useBrand);
}

// ===== ì´ë¯¸ì§€ ëª¨ë¸ ì„¤ì • =====
async function setImageModel(model) {
    state.imageModel = model;
    
    try {
        await pywebview.api.save_image_model(model);
        updateImageModelUI();
    } catch (e) {
        console.error('ëª¨ë¸ ì €ì¥ ì‹¤íŒ¨:', e);
    }
}

function updateImageModelUI() {
    document.querySelectorAll('.model-btn').forEach(btn => {
        btn.classList.remove('active', 'border-lime-400', 'bg-lime-50');
        btn.classList.add('border-zinc-200');
    });
    
    const activeBtn = state.imageModel === 'gemini-3-pro' ? 
        document.getElementById('modelPro') : document.getElementById('modelFlash');
    
    if (activeBtn) {
        activeBtn.classList.add('active', 'border-lime-400', 'bg-lime-50');
        activeBtn.classList.remove('border-zinc-200');
    }
}

// ===== íƒ­ ì „í™˜ =====
function switchTab(tab) {
    state.currentTab = tab;
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('active');
        el.classList.add('text-zinc-400');
    });
    document.getElementById(`tab-${tab}`).classList.remove('hidden');
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    document.querySelector(`[data-tab="${tab}"]`).classList.remove('text-zinc-400');
}

// ===== ì´ë¯¸ì§€ ì—…ë¡œë“œ =====
function setupDropZone() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });
}

function handleFile(file) {
    if (!file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = e => {
        state.uploadedImage = e.target.result;
        document.getElementById('previewImage').src = state.uploadedImage;
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('uploadPlaceholder').classList.add('hidden');
        document.getElementById('previewContainer').classList.remove('hidden');
        document.getElementById('clearImageBtn').classList.remove('hidden');
        document.getElementById('generateBtn').disabled = false;
    };
    reader.readAsDataURL(file);
}

function clearImage() {
    state.uploadedImage = null;
    document.getElementById('uploadPlaceholder').classList.remove('hidden');
    document.getElementById('previewContainer').classList.add('hidden');
    document.getElementById('clearImageBtn').classList.add('hidden');
    document.getElementById('generateBtn').disabled = true;
    document.getElementById('fileInput').value = '';
}

// ===== ëª¨ë“œ/ì„±ë³„ ì„ íƒ =====
function setMode(mode) {
    state.mode = mode;
    document.getElementById('modeProduct').className = `py-2.5 text-xs font-bold rounded-lg ${mode === 'product' ? 'bg-white shadow-sm' : 'text-zinc-400'}`;
    document.getElementById('modeModel').className = `py-2.5 text-xs font-bold rounded-lg ${mode === 'model' ? 'bg-white shadow-sm' : 'text-zinc-400'}`;
    document.getElementById('genderSection').classList.toggle('hidden', mode === 'product');
}

function setGender(gender) {
    state.gender = gender;
    document.getElementById('genderFemale').className = `py-2.5 text-xs font-bold rounded-lg ${gender === 'ì—¬ì„±' ? 'bg-zinc-900 text-white' : 'text-zinc-400'}`;
    document.getElementById('genderMale').className = `py-2.5 text-xs font-bold rounded-lg ${gender === 'ë‚¨ì„±' ? 'bg-zinc-900 text-white' : 'text-zinc-400'}`;
}

// ===== ì´ë¯¸ì§€ ìƒì„± =====
async function generateImage() {
    if (!state.uploadedImage) return;
    
    const btn = document.getElementById('generateBtn');
    btn.disabled = true;
    document.getElementById('generateBtnIcon').classList.add('hidden');
    document.getElementById('generateBtnText').textContent = 'ìƒì„± ì¤‘...';
    document.getElementById('generateBtnLoading').classList.remove('hidden');
    
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('resultGrid').classList.add('hidden');
    document.getElementById('loadingState').classList.remove('hidden');
    
    try {
        const result = await pywebview.api.generate_image(
            state.uploadedImage,
            state.mode,
            state.mode === 'model' ? state.gender : '',
            ''
        );
        
        if (result.success) {
            state.generatedImages = result.images;
            displayResults(result.images);
            document.getElementById('downloadAllBtn').disabled = false;
        } else {
            alert('ìƒì„± ì‹¤íŒ¨: ' + result.error);
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
        }
    } catch (e) {
        alert('ì˜¤ë¥˜: ' + e);
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('emptyState').classList.remove('hidden');
    } finally {
        btn.disabled = false;
        document.getElementById('generateBtnIcon').classList.remove('hidden');
        document.getElementById('generateBtnText').textContent = 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°';
        document.getElementById('generateBtnLoading').classList.add('hidden');
    }
}

function displayResults(images) {
    document.getElementById('loadingState').classList.add('hidden');
    const grid = document.getElementById('resultGrid');
    grid.innerHTML = '';
    
    const labels = ['ì •ë©´', 'ì¸¡ë©´', 'í›„ë©´', 'ë””í…Œì¼'];
    images.forEach((img, i) => {
        const card = document.createElement('div');
        card.className = 'image-card bg-white rounded-2xl overflow-hidden shadow-lg border border-zinc-100';
        card.innerHTML = `
            <div class="aspect-square bg-zinc-50 flex items-center justify-center p-4">
                <img src="${img}" class="max-w-full max-h-full object-contain rounded-lg" onclick="openImagePreview('${img}')">
            </div>
            <div class="p-3 flex items-center justify-between">
                <span class="text-xs font-bold text-zinc-500">${labels[i]}</span>
                <button onclick="downloadSingle(${i})" class="text-xs font-bold text-lime-600 hover:text-lime-700">ğŸ“¥ ì €ì¥</button>
            </div>
        `;
        grid.appendChild(card);
    });
    
    grid.classList.remove('hidden');
    document.getElementById('canvasInfo').textContent = `${images.length}ì¥ ìƒì„±ë¨`;
}

async function downloadSingle(index) {
    const img = state.generatedImages[index];
    const labels = ['front', 'side', 'back', 'detail'];
    await pywebview.api.save_image(img, `autopic_${labels[index]}.jpg`);
}

async function downloadAll() {
    if (state.generatedImages.length === 0) return;
    await pywebview.api.save_all_images(state.generatedImages);
}

// ===== ë°°ì¹˜ ì²˜ë¦¬ =====
async function selectBatchFolder() {
    const result = await pywebview.api.select_folder();
    if (result.success) {
        state.batchFolder = result.folder;
        document.getElementById('batchFolderInput').value = result.folder;
        loadProductList(result.folder);
        checkBatchState(result.folder);
    }
}

async function openBatchFolder() {
    if (state.batchFolder) await pywebview.api.open_folder(state.batchFolder);
}

async function loadProductList(folder) {
    const result = await pywebview.api.get_product_list(folder);
    if (result.success) {
        state.batchProducts = result.products;
        renderProductList(result.products);
        renderFolderPreview(folder, result.products);
    }
}

function renderFolderPreview(folderPath, products) {
    const previewEl = document.getElementById('folderPreview');
    const treeEl = document.getElementById('folderTree');
    const tipsEl = document.getElementById('folderTips');
    const tipTextEl = document.getElementById('folderTipText');
    
    if (!products.length) {
        previewEl.classList.add('hidden');
        return;
    }
    
    previewEl.classList.remove('hidden');
    
    // ë¶„ë¥˜
    const valid = products.filter(p => p.image_count > 0);
    const warnings = products.filter(p => p.image_count === 0);
    const completed = products.filter(p => p.has_output);
    
    // ìš”ì•½ ì—…ë°ì´íŠ¸
    document.getElementById('validCount').textContent = valid.length;
    document.getElementById('ignoredCount').textContent = '0';
    
    const warningBadge = document.getElementById('warningBadge');
    if (warnings.length > 0) {
        warningBadge.classList.remove('hidden');
        document.getElementById('warningCount').textContent = warnings.length;
    } else {
        warningBadge.classList.add('hidden');
    }
    
    // í´ë”ëª… ì¶”ì¶œ
    const folderName = folderPath.split(/[\\/]/).pop();
    
    // íŠ¸ë¦¬ ë Œë”ë§
    let treeHtml = `<div class="text-lime-400 font-bold">ğŸ“ ${folderName}/</div>`;
    
    products.forEach((p, idx) => {
        const isLast = idx === products.length - 1;
        const prefix = isLast ? 'â””â”€â”€ ' : 'â”œâ”€â”€ ';
        
        let icon, colorClass, statusText;
        if (p.image_count === 0) {
            icon = 'âš ï¸';
            colorClass = 'text-amber-400';
            statusText = 'ì´ë¯¸ì§€ ì—†ìŒ';
        } else if (p.has_output) {
            icon = 'âœ…';
            colorClass = 'text-lime-400';
            statusText = `ì™„ë£Œ (${p.output_count}ì¥)`;
        } else {
            icon = 'ğŸ“‚';
            colorClass = 'text-zinc-300';
            statusText = `ì´ë¯¸ì§€ ${p.image_count}ì¥`;
        }
        
        treeHtml += `
            <div class="${colorClass} flex items-center gap-2">
                <span class="text-zinc-500">${prefix}</span>
                <span>${icon} ${p.name}/</span>
                <span class="text-zinc-500 text-[10px]">â† ${statusText}</span>
            </div>`;
    });
    
    treeEl.innerHTML = treeHtml;
    
    // íŒ í‘œì‹œ
    if (warnings.length > 0) {
        tipsEl.classList.remove('hidden');
        tipTextEl.textContent = `${warnings.length}ê°œ í´ë”ì— ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ê° ìƒí’ˆ í´ë”ì— ì´ë¯¸ì§€ íŒŒì¼(JPG, PNG, WebP)ì„ ë„£ì–´ì£¼ì„¸ìš”.`;
    } else if (valid.length > 0 && completed.length === valid.length) {
        tipsEl.classList.remove('hidden');
        tipTextEl.textContent = 'ëª¨ë“  ìƒí’ˆì´ ì²˜ë¦¬ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰';
    } else if (valid.length > 0) {
        tipsEl.classList.remove('hidden');
        tipTextEl.textContent = `${valid.length}ê°œ ìƒí’ˆì´ ì²˜ë¦¬ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. "ì²˜ë¦¬ ì‹œì‘" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì§„í–‰í•˜ì„¸ìš”.`;
    } else {
        tipsEl.classList.add('hidden');
    }
}

function renderProductList(products) {
    const tbody = document.getElementById('productTableBody');
    if (!products.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-zinc-400">ìƒí’ˆ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        document.getElementById('productCount').textContent = '0ê°œ';
        return;
    }
    
    tbody.innerHTML = products.map((p, i) => `
        <tr class="border-t border-zinc-100 hover:bg-zinc-50">
            <td class="p-3 text-center"><input type="checkbox" class="product-check w-4 h-4 accent-lime-500" data-index="${i}" ${!p.has_output ? 'checked' : ''}></td>
            <td class="p-3 font-medium">${p.name}</td>
            <td class="p-3 text-center">${p.image_count}ì¥</td>
            <td class="p-3 text-center">${p.has_text ? 'âœ…' : 'âŒ'}</td>
            <td class="p-3 text-center">
                ${p.has_output ? 
                    `<span class="inline-flex items-center gap-1 text-xs font-bold text-lime-600 bg-lime-50 px-2 py-1 rounded-lg">âœ… ì™„ë£Œ (${p.output_count}ì¥)</span>
                     <button onclick="previewProduct('${p.path}')" class="ml-1 text-xs text-zinc-400 hover:text-zinc-600">ğŸ‘ï¸</button>` : 
                    '<span class="text-xs text-zinc-400">ëŒ€ê¸°</span>'
                }
            </td>
        </tr>
    `).join('');
    
    document.getElementById('productCount').textContent = `${products.length}ê°œ`;
}

function toggleSelectAll() {
    const checkAll = document.getElementById('selectAllCheck').checked;
    document.querySelectorAll('.product-check').forEach(cb => cb.checked = checkAll);
}

function refreshProductList() {
    if (state.batchFolder) loadProductList(state.batchFolder);
}

function setBatchGender(gender) {
    state.batchGender = gender;
    document.querySelectorAll('.batch-gender-btn').forEach(btn => {
        btn.className = 'batch-gender-btn px-3 py-1.5 text-xs font-bold rounded-lg bg-zinc-100 text-zinc-600';
    });
    const activeBtn = document.getElementById(`batchGender${gender === 'auto' ? 'Auto' : gender}`);
    if (activeBtn) activeBtn.className = 'batch-gender-btn px-3 py-1.5 text-xs font-bold rounded-lg bg-lime-400 text-zinc-900';
}

async function checkBatchState(folder) {
    const result = await pywebview.api.check_batch_state(folder);
    if (result.has_state) {
        document.getElementById('resumeAlert').classList.remove('hidden');
        document.getElementById('resumeInfo').textContent = `${result.current_index}/${result.total} ì™„ë£Œ, ${result.remaining}ê°œ ë‚¨ìŒ`;
    } else {
        document.getElementById('resumeAlert').classList.add('hidden');
    }
}

async function resumeBatch() {
    await pywebview.api.resume_batch_process(state.batchFolder);
    document.getElementById('resumeAlert').classList.add('hidden');
}

async function clearBatchState() {
    await pywebview.api.clear_batch_state(state.batchFolder);
    document.getElementById('resumeAlert').classList.add('hidden');
}

async function startBatchProcess() {
    const selected = Array.from(document.querySelectorAll('.product-check:checked')).map(cb => state.batchProducts[cb.dataset.index].name);
    if (!selected.length) { alert('ì²˜ë¦¬í•  ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”'); return; }
    
    const options = {
        basic_product: document.getElementById('optBasicProduct').checked,
        basic_model: document.getElementById('optBasicModel').checked,
        editorial_product: document.getElementById('optEditorialProduct').checked,
        editorial_model: document.getElementById('optEditorialModel').checked,
        gender: state.batchGender,
    };
    
    state.isProcessing = true;
    state.batchTotal = selected.length;
    state.batchCurrent = 0;
    
    document.getElementById('batchStartBtn').disabled = true;
    document.getElementById('batchStopBtn').disabled = false;
    document.getElementById('batchBtnIcon').textContent = 'â³';
    document.getElementById('batchBtnText').textContent = 'ì²˜ë¦¬ ì¤‘...';
    document.getElementById('batchProgress').style.width = '0%';
    document.getElementById('batchProgressText').textContent = `0/${selected.length} ì²˜ë¦¬ ì¤‘...`;
    
    try {
        const result = await pywebview.api.process_batch(state.batchFolder, selected, options);
        
        if (result.success) {
            // ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('completeMessage').textContent = 
                `ì´ ${result.total}ê°œ ìƒí’ˆ ì¤‘ ${result.success_count}ê°œ ì„±ê³µ, ${result.fail_count}ê°œ ì‹¤íŒ¨`;
            document.getElementById('completeModal').classList.remove('hidden');
            document.getElementById('completeModal').classList.add('flex');
        } else if (result.error_type === 'insufficient_credits') {
            alert(`âš ï¸ í¬ë ˆë”§ ë¶€ì¡±!\n\ní•„ìš”: ${result.required_credits} í¬ë ˆë”§\në³´ìœ : ${result.current_credits} í¬ë ˆë”§\n\nì²˜ë¦¬ ê°€ëŠ¥í•œ ìƒí’ˆ: ${result.possible_count}ê°œ`);
        } else {
            alert('âŒ ì˜¤ë¥˜: ' + result.error);
        }
        refreshProductList();
    } catch (e) {
        alert('âŒ ì˜¤ë¥˜: ' + e);
    } finally {
        state.isProcessing = false;
        document.getElementById('batchStartBtn').disabled = false;
        document.getElementById('batchStopBtn').disabled = true;
        document.getElementById('batchBtnIcon').textContent = 'ğŸš€';
        document.getElementById('batchBtnText').textContent = 'ì²˜ë¦¬ ì‹œì‘';
    }
}

function closeCompleteModal() {
    document.getElementById('completeModal').classList.add('hidden');
    document.getElementById('completeModal').classList.remove('flex');
    document.getElementById('batchProgress').style.width = '0%';
    document.getElementById('batchProgressText').textContent = 'ëŒ€ê¸° ì¤‘';
}

async function stopBatchProcess() {
    await pywebview.api.stop_batch();
    document.getElementById('batchStopBtn').disabled = true;
}

async function previewProduct(path) {
    const result = await pywebview.api.get_product_preview(path);
    if (result.success) {
        document.getElementById('modalTitle').textContent = result.name;
        let html = '<div class="grid grid-cols-2 gap-4">';
        const typeLabels = { basic_product: 'ğŸ›ï¸ ê¸°ë³¸ ì •ë¬¼', basic_model: 'ğŸ‘¤ ê¸°ë³¸ ëª¨ë¸', editorial_product: 'ğŸ“¸ í™”ë³´ ì •ë¬¼', editorial_model: 'ğŸ­ í™”ë³´ ëª¨ë¸' };
        for (const [type, images] of Object.entries(result.images)) {
            html += `<div class="bg-zinc-50 rounded-xl p-4"><h4 class="font-bold text-sm mb-3">${typeLabels[type] || type}</h4><div class="grid grid-cols-2 gap-2">`;
            images.forEach(img => { html += `<img src="${img.thumbnail}" class="w-full rounded-lg cursor-pointer hover:opacity-80" onclick="openImagePreview('${img.thumbnail}')">`; });
            html += '</div></div>';
        }
        html += '</div>';
        document.getElementById('modalContent').innerHTML = html;
        document.getElementById('previewModal').classList.remove('hidden');
        document.getElementById('previewModal').classList.add('flex');
    }
}

function closePreviewModal() {
    document.getElementById('previewModal').classList.add('hidden');
    document.getElementById('previewModal').classList.remove('flex');
}

function openImagePreview(src) {
    window.open(src, '_blank');
}

// ===== ë¸Œëœë“œ ê´€ë¦¬ =====
async function addBrand() {
    const input = document.getElementById('newBrandInput');
    const name = input.value.trim().toUpperCase();
    if (!name) return;
    if (!state.brands.includes(name)) {
        state.brands.push(name);
        state.brands.sort();
        await pywebview.api.save_brands(state.brands);
        renderBrands();
    }
    input.value = '';
}

async function removeBrand(name) {
    state.brands = state.brands.filter(b => b !== name);
    await pywebview.api.save_brands(state.brands);
    renderBrands();
}

function renderBrands() {
    const container = document.getElementById('brandList');
    if (!state.brands.length) {
        container.innerHTML = '<p class="text-sm text-zinc-400">ë“±ë¡ëœ ë¸Œëœë“œê°€ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
    }
    container.innerHTML = state.brands.map(b => `
        <span class="inline-flex items-center gap-1 bg-zinc-100 px-3 py-1.5 rounded-lg text-sm font-medium">
            ${b}
            <button onclick="removeBrand('${b}')" class="text-zinc-400 hover:text-red-500 ml-1">Ã—</button>
        </span>
    `).join('');
}

// ===== í¬ë ˆë”§ & ë¡œê·¸ì•„ì›ƒ =====
async function refreshCredits() {
    try {
        const result = await pywebview.api.check_web_credits();
        if (result.success) {
            document.getElementById('settingsCreditsValue').textContent = result.credits;
            // ìƒë‹¨ API ìƒíƒœë„ ì—°ê²°ë¨ìœ¼ë¡œ í‘œì‹œ
            updateApiStatus(true);
            // API í‚¤ ì´ë¦„ í‘œì‹œ
            if (result.key_name) {
                document.getElementById('keyNameDisplay').classList.remove('hidden');
                document.getElementById('keyNameDisplay').classList.add('flex');
                document.getElementById('keyNameText').textContent = result.key_name;
            }
        } else {
            // ì‹¤íŒ¨ ì‹œ ë¯¸ì—°ê²° í‘œì‹œ
            updateApiStatus(false);
        }
    } catch (e) {
        console.error('í¬ë ˆë”§ ì¡°íšŒ ì‹¤íŒ¨:', e);
        updateApiStatus(false);
    }
}

async function logout() {
    if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në‹¤ì‹œ ì‚¬ìš©í•˜ë ¤ë©´ API í‚¤ë¥¼ ë‹¤ì‹œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.')) {
        return;
    }
    
    const result = await pywebview.api.logout();
    if (result.success) {
        // ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
        window.location.href = 'login.html';
    } else {
        alert('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ' + result.error);
    }
}

function updateApiStatus(connected) {
    const el = document.getElementById('apiStatus');
    el.innerHTML = connected ?
        '<span class="w-2 h-2 rounded-full bg-lime-500"></span><span class="text-xs font-medium text-zinc-700">API ì—°ê²°ë¨</span>' :
        '<span class="w-2 h-2 rounded-full bg-red-500"></span><span class="text-xs font-medium text-zinc-500">API ë¯¸ì—°ê²°</span>';
}

// ===== ë¡œê·¸ ë° ì§„í–‰ë¥  =====
function startLogPolling() {
    setInterval(async () => {
        try {
            const logs = await pywebview.api.get_logs();
            if (logs.length) {
                const container = document.getElementById('logContainer');
                logs.forEach(log => {
                    // PROGRESS ë©”ì‹œì§€ ì²˜ë¦¬ (ì§„í–‰ë¥  ì—…ë°ì´íŠ¸)
                    if (log.message.startsWith('PROGRESS:')) {
                        const parts = log.message.split(':');
                        if (parts.length >= 3) {
                            const current = parseInt(parts[1]);
                            const total = parseInt(parts[2]);
                            if (!isNaN(current) && !isNaN(total) && total > 0) {
                                const percent = Math.round((current / total) * 100);
                                document.getElementById('batchProgress').style.width = `${percent}%`;
                                document.getElementById('batchProgressText').textContent = `${current}/${total} ì²˜ë¦¬ ì¤‘... (${percent}%)`;
                            }
                        }
                        return; // PROGRESS ë©”ì‹œì§€ëŠ” ë¡œê·¸ì— í‘œì‹œ ì•ˆ í•¨
                    }
                    
                    // ì¼ë°˜ ë¡œê·¸ í‘œì‹œ
                    const line = document.createElement('div');
                    line.className = log.level === 'ERROR' ? 'text-red-400' : (log.level === 'WARNING' ? 'text-yellow-400' : 'text-zinc-300');
                    line.textContent = `[${log.time}] ${log.message}`;
                    container.appendChild(line);
                });
                container.scrollTop = container.scrollHeight;
            }
        } catch (e) {}
    }, 300); // 300msë¡œ ë” ë¹ ë¥´ê²Œ í´ë§
}

async function clearLogs() {
    await pywebview.api.clear_logs();
    document.getElementById('logContainer').innerHTML = '<p class="text-zinc-500">ë¡œê·¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</p>';
}
</script>
</body>
</html>
